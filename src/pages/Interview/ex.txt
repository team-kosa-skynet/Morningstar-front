 1. API ì‘ë‹µ êµ¬ì¡°

  /api/interview/session?withAudio=true ì‘ë‹µ

  interface StartSessionResponse {
    sessionId: string;
    greeting: string;
    firstQuestion: string;
    totalQuestions: number;
    tts: TtsPayload | null;  // withAudio=trueì¼ ë•Œë§Œ í¬í•¨
  }

  /api/interview/turn?withAudio=true ì‘ë‹µ

  interface NextTurnResponse {
    nextQuestion: string;
    questionIntent: string;
    answerGuides: string[];
    coachingTips: string;
    scoreDelta: Record<string, number>;
    currentIndex: number;
    done: boolean;
    tts: TtsPayload | null;  // withAudio=trueì¼ ë•Œë§Œ í¬í•¨
  }

  interface TtsPayload {
    format: string;  // "mp3", "wav", "ogg" ë“±
    base64: string;  // Base64 ì¸ì½”ë”©ëœ ì˜¤ë””ì˜¤ ë°ì´í„°
  }

  2. í”„ë¡ íŠ¸ì—”ë“œ ì˜¤ë””ì˜¤ ì²˜ë¦¬ êµ¬í˜„

  Base64 to Blob ë³€í™˜ í•¨ìˆ˜

  function base64ToBlob(base64Data, mimeType) {
    const byteCharacters = atob(base64Data);
    const byteNumbers = new Array(byteCharacters.length);

    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }

    const byteArray = new Uint8Array(byteNumbers);
    return new Blob([byteArray], { type: mimeType });
  }

  ì˜¤ë””ì˜¤ ì¬ìƒ í•¨ìˆ˜

  function playTtsAudio(ttsPayload) {
    if (!ttsPayload || !ttsPayload.base64) {
      console.warn('TTS ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return Promise.resolve();
    }

    const { format, base64 } = ttsPayload;
    const mimeType = `audio/${format}`;
    const blob = base64ToBlob(base64, mimeType);
    const audioUrl = URL.createObjectURL(blob);

    const audio = new Audio(audioUrl);

    return new Promise((resolve, reject) => {
      audio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        resolve();
      };

      audio.onerror = (error) => {
        console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', error);
        URL.revokeObjectURL(audioUrl);
        reject(error);
      };

      audio.play().catch(reject);
    });
  }

  3. APIë³„ êµ¬ì²´ì ì¸ ì²˜ë¦¬ ë°©ë²•

  Session ì‹œì‘ API ì²˜ë¦¬

  async function startInterviewSession(requestData) {
    try {
      const response = await fetch('/api/interview/session?withAudio=true', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(requestData)
      });

      const data = await response.json();

      // ì„¸ì…˜ ì •ë³´ ì €ì¥
      setSessionId(data.sessionId);
      setGreeting(data.greeting);
      setFirstQuestion(data.firstQuestion);
      setTotalQuestions(data.totalQuestions);

      // ì˜¤ë””ì˜¤ ì¬ìƒ (ì¸ì‚¬ë§ + ì²« ë²ˆì§¸ ì§ˆë¬¸)
      if (data.tts) {
        await playTtsAudio(data.tts);
      }

      return data;
    } catch (error) {
      console.error('ì„¸ì…˜ ì‹œì‘ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  Turn API ì²˜ë¦¬

  async function submitAnswer(answerData) {
    try {
      const response = await fetch('/api/interview/turn?withAudio=true', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(answerData)
      });

      const data = await response.json();

      // UI ì—…ë°ì´íŠ¸
      setNextQuestion(data.nextQuestion);
      setQuestionIntent(data.questionIntent);
      setAnswerGuides(data.answerGuides);
      setCoachingTips(data.coachingTips);
      setCurrentIndex(data.currentIndex);
      setIsDone(data.done);

      // ì ìˆ˜ ë³€í™” í‘œì‹œ
      if (data.scoreDelta) {
        updateScoreDisplay(data.scoreDelta);
      }

      // ë‹¤ìŒ ì§ˆë¬¸ ì˜¤ë””ì˜¤ ì¬ìƒ
      if (data.tts && !data.done) {
        await playTtsAudio(data.tts);
      }

      return data;
    } catch (error) {
      console.error('ë‹µë³€ ì œì¶œ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  4. React Hook êµ¬í˜„ ì˜ˆì‹œ

  import { useState, useCallback } from 'react';

  function useInterviewAudio() {
    const [isPlaying, setIsPlaying] = useState(false);
    const [currentAudio, setCurrentAudio] = useState(null);

    const stopCurrentAudio = useCallback(() => {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        setCurrentAudio(null);
        setIsPlaying(false);
      }
    }, [currentAudio]);

    const playTtsAudio = useCallback(async (ttsPayload) => {
      if (!ttsPayload?.base64) return;

      // ì´ì „ ì˜¤ë””ì˜¤ ì •ì§€
      stopCurrentAudio();

      try {
        setIsPlaying(true);

        const { format, base64 } = ttsPayload;
        const mimeType = `audio/${format}`;
        const blob = base64ToBlob(base64, mimeType);
        const audioUrl = URL.createObjectURL(blob);

        const audio = new Audio(audioUrl);
        setCurrentAudio(audio);

        return new Promise((resolve, reject) => {
          audio.onended = () => {
            setIsPlaying(false);
            setCurrentAudio(null);
            URL.revokeObjectURL(audioUrl);
            resolve();
          };

          audio.onerror = (error) => {
            setIsPlaying(false);
            setCurrentAudio(null);
            URL.revokeObjectURL(audioUrl);
            reject(error);
          };

          audio.play().catch(reject);
        });
      } catch (error) {
        setIsPlaying(false);
        setCurrentAudio(null);
        throw error;
      }
    }, [stopCurrentAudio]);

    return {
      isPlaying,
      playTtsAudio,
      stopCurrentAudio
    };
  }

  5. ì‚¬ìš© ì˜ˆì‹œ

  function InterviewComponent() {
    const { isPlaying, playTtsAudio, stopCurrentAudio } = useInterviewAudio();
    const [sessionData, setSessionData] = useState(null);

    const handleStartSession = async () => {
      const data = await startInterviewSession(requestData);
      setSessionData(data);

      // ì¸ì‚¬ë§ê³¼ ì²« ì§ˆë¬¸ ìë™ ì¬ìƒ
      if (data.tts) {
        await playTtsAudio(data.tts);
      }
    };

    const handleSubmitAnswer = async (answer) => {
      const data = await submitAnswer({ answer, sessionId });

      // ë‹¤ìŒ ì§ˆë¬¸ ìë™ ì¬ìƒ
      if (data.tts && !data.done) {
        await playTtsAudio(data.tts);
      }
    };

    return (
      <div>
        {isPlaying && <div>ğŸ”Š ìŒì„± ì¬ìƒ ì¤‘...</div>}
        <button onClick={stopCurrentAudio} disabled={!isPlaying}>
          ìŒì„± ì •ì§€
        </button>
        {/* ë‚˜ë¨¸ì§€ UI */}
      </div>
    );
  }

  6. ì£¼ìš” ê³ ë ¤ì‚¬í•­

  1. ì˜¤ë””ì˜¤ ì¬ìƒ ìƒíƒœ ê´€ë¦¬: ì´ì „ ì˜¤ë””ì˜¤ê°€ ì¬ìƒ ì¤‘ì¼ ë•Œ ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ ì²˜ë¦¬
  2. ë©”ëª¨ë¦¬ ê´€ë¦¬: URL.revokeObjectURL() ë°˜ë“œì‹œ í˜¸ì¶œ
  3. ì—ëŸ¬ ì²˜ë¦¬: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, ì˜¤ë””ì˜¤ ë””ì½”ë”© ì‹¤íŒ¨ ë“±
  4. ì‚¬ìš©ì ê²½í—˜: ë¡œë”© ìƒíƒœ, ì¬ìƒ ìƒíƒœ í‘œì‹œ
  5. ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì •ì±…: ì‚¬ìš©ì ì¸í„°ë™ì…˜ í›„ì—ë§Œ ìë™ì¬ìƒ ê°€ëŠ¥
